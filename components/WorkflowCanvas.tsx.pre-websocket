import React from 'react';
import ReactFlow, {
  Background,
  Controls,
  MiniMap,
  ReactFlowProvider,
  NodeTypes,
  BackgroundVariant,
} from 'reactflow';
import 'reactflow/dist/style.css';

import { ChatMessage, LLMConfig, WorkflowNode } from '../types';
import { useReactFlowAdapter } from '../hooks/useReactFlowAdapter';
import { CustomAgentNode } from './CustomAgentNode';
import { WorkflowCanvasProvider } from '../contexts/WorkflowCanvasContext';

// Types de nodes personnalisés
const nodeTypes: NodeTypes = {
  customAgent: CustomAgentNode,
};

interface WorkflowCanvasProps {
  nodes: WorkflowNode[];
  llmConfigs: LLMConfig[];
  onDeleteNode: (nodeId: string) => void;
  onUpdateNodeMessages: (nodeId: string, messages: ChatMessage[] | ((prev: ChatMessage[]) => ChatMessage[])) => void;
  onUpdateNodePosition: (nodeId: string, position: { x: number; y: number }) => void;
  onToggleNodeMinimize: (nodeId: string) => void;
  onOpenImagePanel: (nodeId: string) => void;
  onOpenImageModificationPanel: (nodeId: string, sourceImage: string, mimeType: string) => void;
  onOpenFullscreen: (sourceImage: string, mimeType: string) => void;
}

const WorkflowCanvasInner = ({ 
  nodes, 
  llmConfigs, 
  onDeleteNode, 
  onUpdateNodeMessages, 
  onUpdateNodePosition, 
  onToggleNodeMinimize, 
  onOpenImagePanel, 
  onOpenImageModificationPanel, 
  onOpenFullscreen 
}: WorkflowCanvasProps) => {
  // Adapter les données pour React Flow
  const {
    nodes: reactFlowNodes,
    edges,
    onNodesChange,
    onEdgesChange,
    onConnect,
  } = useReactFlowAdapter({
    nodes,
    onUpdateNodePosition,
    onDeleteNode,
  });

  // Préparer le contexte pour les CustomAgentNodes
  const contextValue = {
    llmConfigs,
    onDeleteNode,
    onUpdateNodeMessages,
    onToggleNodeMinimize,
    onOpenImagePanel,
    onOpenImageModificationPanel,
    onOpenFullscreen,
  };

  return (
    <WorkflowCanvasProvider value={contextValue}>
      <div className="workflow-canvas-container" style={{ width: '100%', height: '100%' }}>
        <ReactFlow
          nodes={reactFlowNodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          nodeTypes={nodeTypes}
          fitView
          defaultViewport={{ x: 0, y: 0, zoom: 1 }}
          defaultEdgeOptions={{
            style: { 
              stroke: '#00ff88', 
              strokeWidth: 2,
              filter: 'drop-shadow(0 0 8px #00ff88aa)'
            },
            type: 'smoothstep',
          }}
        >
          {/* Background gaming avec grille laser */}
          <Background 
            variant={BackgroundVariant.Dots}
            gap={20}
            size={2}
            color="#0066ff40"
            style={{
              background: 'linear-gradient(45deg, #000a1a 0%, #001122 50%, #000a1a 100%)'
            }}
          />
          
          {/* Controls avec style gaming */}
          <Controls 
            style={{
              button: {
                backgroundColor: '#001122',
                border: '1px solid #0066ff',
                color: '#00ff88',
              },
            }}
          />
          
          {/* MiniMap tactique style gaming */}
          <MiniMap
            nodeStrokeColor="#0066ff"
            nodeColor="#001122"
            nodeBorderRadius={8}
            style={{
              backgroundColor: '#000a1a',
              border: '2px solid #0066ff',
              borderRadius: '8px',
            }}
            maskColor="rgba(0, 10, 26, 0.8)"
          />
        </ReactFlow>
      </div>
    </WorkflowCanvasProvider>
  );
};

// Wrapper avec ReactFlowProvider
export const WorkflowCanvas = (props: WorkflowCanvasProps) => {
  return (
    <ReactFlowProvider>
      <WorkflowCanvasInner {...props} />
    </ReactFlowProvider>
  );
};